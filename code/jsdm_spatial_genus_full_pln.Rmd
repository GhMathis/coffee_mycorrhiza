---
title: "Untitled"
output: html_document
date: "2025-08-07"
editor_options: 
  chunk_output_type: inline
---

```{r include=FALSE}
library(tidyverse)
library(raster)
library(mapview)
library(leaflet)
library(leafem)
library(rasterVis)
library(readxl)
library(sf)
library(pals)

library(Hmsc)
library(ape)
```
# Spatial covariate

## Sampling points
```{r echo=FALSE}
metadata <- read_xlsx(path = "data/Metadata_Doreen_070525.xlsx")

utm_coords <- metadata %>%
  mutate(
    zone = as.numeric(substr(easting, 1, 2)),
    band = substr(easting, 3, 3),
    easting = as.numeric(sub(".* ", "", easting)),
    northing = as.numeric(northing),

    hemisphere = ifelse(band == "N", "north", "south") # M = South Hemisphere
  )

# Function to convert a single row to lat/lon
convert_to_wgs84 <- function(zone, hemisphere, easting, northing,Sample_code) {
  epsg <- if (hemisphere == "north") {
    32600 + zone  # Northern hemisphere UTM EPSG codes
  } else {
    32700 + zone  # Southern hemisphere UTM EPSG codes
  }

  point <- st_sfc(st_point(c(easting, northing)), crs = epsg)
  point_wgs84 <- st_transform(point, crs = 4326)
  coords <- st_coordinates(point_wgs84)
  tibble( lon = coords[1], lat = coords[2],Sample_code = Sample_code)
}
utm_coords %>%
  mutate(zone = case_when(zone==32~ 36,
                             .default = zone),
          northing = case_when(Sample_code == "N17" ~ 86562,
                             .default = northing)) -> utm_coords
# Apply to each row
wgs84_coords <- pmap_dfr(utm_coords[, c("zone", "hemisphere", "easting", "northing","Sample_code")], convert_to_wgs84) %>%
  left_join(metadata, by = "Sample_code") %>%
  st_as_sf(coords = c("lon", "lat"),crs = 4326) %>%
  mutate(
     lon= st_coordinates(.)[,1],
     lat= st_coordinates(.)[,2]
  )


leaflet() %>% 
  addTiles() %>%
  addMarkers(data=wgs84_coords,~lon, ~lat, popup = ~paste(round(lat,2), round(lon,2)) , label = ~Sample_code)%>%
  addCircleMarkers(data = wgs84_coords, lng = ~lon,
                  lat = ~lat, radius = 8, color = "blue", fillOpacity = 0.8)
```

## Land degradation

This metric come from : https://gmesgeoportal.rcmrd.org/maps/8005edb1d35249e89f52260971c11c8b/about
key parameters used include: soil erosivity, slope, rainfall intensity, population and land cover

```{r echo=FALSE}
land_degradation_raster <- raster("outputs/raster/land_degradation_reclassify.tif")
land_degradation_type <- levels(land_degradation_raster)[[1]]
land_degradation_type <- land_degradation_type %>%
  mutate(land_degra = factor(land_degra, levels = c("Low", "Medium", "High")))
land_degradation_df <- raster::extract(land_degradation_raster,  wgs84_coords)%>%
  tibble(ID = .,
  Sample_code  = wgs84_coords$Sample_code)%>%
  left_join(land_degradation_type,  by = "ID")

myPal1 <- rev(RColorBrewer::brewer.pal('PRGn', n=3))


leaflet() %>%
  addTiles() %>% 
  addRasterImage(land_degradation_raster, opacity = 0.7,
                 color = myPal1) %>%
   addLegend(
    "bottomright",
    pal = colorFactor(palette=myPal1, domain = land_degradation_type$land_degra),
    values = land_degradation_type$land_degra,
    title = "Land Degradation"
  )
```

## Land cover

This land cover metric is not ideal. Most of the sampling point fall in *Subsistence Cropland* (cf. 4 map below), leading to not enough replication of some land cover class for the model. We will probably replace this raster by agro-ecological zone one

```{r echo=FALSE}
land_cover_raster <- raster("outputs/raster/land_cover_lower_res.tif")

land_cover_type <- levels(land_cover_raster)[[1]] %>%
  dplyr::select(ID,Land_Cover) %>%
  mutate(Land_Cover = factor(Land_Cover, levels = levels(land_cover_raster)[[1]]$Land_Cover))


land_cover_df <- raster::extract(land_cover_raster, wgs84_coords) %>%
 tibble(ID = .,
    Sample_code  = wgs84_coords$Sample_code) %>%
    left_join(land_cover_type, by = "ID")

myPal2 <- pals::stepped2(n=18)

pal_land_cover <- colorFactor(myPal2[unique(land_cover_df$ID)], 
                   domain = wgs84_coords$Land_Cover)
leaflet() %>%
  addTiles() %>% 
  addRasterImage(land_cover_raster, opacity = 0.7,
                 colors = myPal2) %>%
  addLegend(
    "bottomright",
    pal = colorFactor(palette=myPal2, domain = land_cover_type$Land_Cover),
    values =land_cover_type$Land_Cover,
    title = "Land Cover"
  )
```
## Cluster agroecologique

```{r}
cluster_agro_raster <- raster("outputs/raster/cluster_agro_lower_res.tif")
cluster_agro_type <- levels(cluster_agro_raster)[[1]] %>%
  dplyr::select(ID, Cluster) %>%
  mutate(Cluster = factor(Cluster, levels = levels(cluster_agro_raster)[[1]]$Cluster))

cluster_agro_df <- raster::extract(cluster_agro_raster, wgs84_coords) %>%
  tibble(ID = ., Sample_code = wgs84_coords$Sample_code) %>%
  left_join(cluster_agro_type, by = "ID")

myPal3 <- ggsci::pal_simpsons()(8)

leaflet() %>%
  addTiles() %>%
  addRasterImage(cluster_agro_raster, opacity = 0.7, colors = myPal3) %>%
  addLegend(
    "bottomright",
    pal = colorFactor(palette = myPal3, domain = cluster_agro_type$Cluster),
    values = cluster_agro_type$Cluster,
    title = "Land Cover"
  )
```


## NDVI

Indice for vegetation quantity 


https://planetarycomputer.microsoft.com/dataset/sentinel-3-synergy-v10-l2-netcdf

```{r echo=FALSE}
ndvi_uganda <- raster("outputs/raster/ndvi_uganda_lower_res.tif")

ndvi_df <- raster::extract(ndvi_uganda, wgs84_coords)%>%
 tibble(ndvi = .,
    Sample_code  = wgs84_coords$Sample_code)

pal_ndvi <- colorNumeric("viridis", domain = c(0, 1))
leaflet() %>%
  addTiles() %>% 
  addRasterImage(ndvi_uganda, opacity = 0.7) %>%
  addLegend(
    "bottomright",
    pal = pal_ndvi,
    values = c(0, 1),
  )
```

## Precipitation and Temperature max min

This is still work in progess, here the precipitation are for only **May 2023**. It is hard to get the data but I will try to obtain mean or sum precipitation for a hole year before June 2023.

```{r echo=FALSE}
precip_uganda_resampled <- raster("outputs/raster/precip_2023_lower_res.tif")

precip_df <- raster::extract(precip_uganda_resampled, wgs84_coords)%>%
 tibble(precip = .,
    Sample_code  = wgs84_coords$Sample_code)
pal_precip <- colorNumeric("Spectral", domain = c(0, 1))
leaflet() %>%
  addTiles() %>%
  addRasterImage(precip_uganda_resampled, opacity = 0.5)%>%
    addLegend(
    "bottomright",
    pal = pal_precip,
    values = c(0, 1),
  )

```
```{r echo=FALSE}
tmax_uganda_resampled <- raster("outputs/raster/tmax_2023_lower_res.tif")

tmax_df <- raster::extract(tmax_uganda_resampled, wgs84_coords)%>%
 tibble(tmax = .,
    Sample_code  = wgs84_coords$Sample_code)
pal_t <- colorNumeric("Spectral", domain = c(0, 34))
leaflet() %>%
  addTiles() %>%
  addRasterImage(tmax_uganda_resampled, opacity = 0.5)%>%
    addLegend(
    "bottomright",
    pal = pal_t,
    values = c(0, 34),
  )

```

```{r echo=FALSE}
tmin_uganda_resampled <- raster("outputs/raster/tmin_2023_lower_res.tif")

tmin_df <- raster::extract(tmin_uganda_resampled, wgs84_coords)%>%
 tibble(tmin = .,
    Sample_code  = wgs84_coords$Sample_code)
leaflet() %>%
  addTiles() %>%
  addRasterImage(tmin_uganda_resampled, opacity = 0.5)%>%
    addLegend(
    "bottomright",
    pal = pal_t,
    values = c(0, 34),
  )

```
## Agroecological zone

```{r echo=FALSE}
wgs84_coords %>%
  left_join(cluster_agro_df, by = "Sample_code") %>%
  left_join(land_degradation_df, by = "Sample_code") %>%
  left_join(ndvi_df, by = "Sample_code") %>%
  left_join(precip_df, by = "Sample_code") %>%
  left_join(tmax_df, by = "Sample_code") %>%
  left_join(tmin_df, by = "Sample_code") -> wgs84_coords

```

## Some value at the sample level (extract from the raster)

```{r echo=FALSE}
pal_land_degradation <- colorFactor(myPal1[unique(land_degradation_df$ID)], 
                   domain = wgs84_coords$land_degra)

leaflet(wgs84_coords) %>%
  addTiles() %>%
  addRasterImage(land_degradation_raster, opacity = 0.7,
                 color = myPal1) %>%
  addCircleMarkers(
    ~lon, ~lat,
    color = "black",
    fillColor = ~pal_land_degradation(land_degra),
    radius = 6,
    weight = 2,
    stroke = T,
    fillOpacity = 0.8,
    popup = ~land_degra,
    label = ~Sample_code,
    group = ~land_degra
  ) %>%
   addLegend(
    "bottomright",
    pal = colorFactor(palette=myPal1, domain = land_degradation_type$land_degra),
    values = land_degradation_type$land_degra,
    title = "Land Degradation"
  )

# Cluster agro map with circle markers

pal_cluster_agro <- colorFactor(myPal3[1:8], domain = levels(cluster_agro_raster)[[1]]$Cluster)

leaflet(wgs84_coords) %>%
  addTiles() %>%
  addRasterImage(cluster_agro_raster, opacity = 0.7, color = myPal3) %>%
  addCircleMarkers(
    ~lon, ~lat,
    color = "black",
    fillColor = ~pal_cluster_agro(Cluster),
    radius = 6,
    weight = 2,
    stroke = TRUE,
    fillOpacity = 0.8,
    popup = ~Cluster,
    label = ~Sample_code,
    group = ~Cluster
  ) %>%
  addLegend(
    "bottomright",
    pal = colorFactor(palette = myPal3, domain = cluster_agro_type$Cluster),
    values = cluster_agro_type$Cluster,
    title = "Agro-ecological cluster"
  )
```

# Joint species distribution models at the genus level

```{r echo=FALSE}
amf_genus_rare <- read.table("outputs/abundance_tables/Robust_MiSeq_18S_AMf_20241120_125_samples.OTU.filtered.cleaved.nosubstringOTUs.mumu.rarefy.Glomeromycota_genus.txt", header = TRUE, stringsAsFactors = FALSE)
genus_tree <- read.tree("outputs/phylo_tree/Robust_MiSeq_18S_AMf_20241120_125_samples_Eukaryome_Glomeromycota_genus.tree")

# Inspect and root tree
genus_tree$tip.label
plot(genus_tree)
genus_tree <- root(genus_tree, "c__Archaeosporomycetes_4")

# Clean tip labels (example transformation)
genus_rename <- genus_tree$tip.label %>%
  str_remove("g__") %>%
  str_replace_all("[a-z]__", "Unknown ") %>%
  str_replace("_(\\d+)$", " (\\1 OTU)")
length(genus_rename)
genus_tree$tip.label <- genus_rename
plot(genus_tree)
str(genus_tree)
```


```{r}
# Prepare Y matrix for families
amf_genus_rare <- amf_genus_rare %>%
  mutate(genus = genus %>%
           str_remove("g__") %>%
           str_replace_all("[a-z]__", "Unknown ") %>%
           str_replace("_(\\d+)$", " (\\1 OTU)")) %>%
  remove_rownames() %>%
  column_to_rownames("genus")

Y_genus <- amf_genus_rare %>%
  filter(rowSums(across(starts_with("ROB")) != 0) > 3) %>%
  t()

# Prepare Y without zeros as a truncated version
Y_genus_trucated <- Y_genus %>%
  as.data.frame() %>%
  rownames_to_column("soil_code") %>%
  pivot_longer(-soil_code) %>%
  mutate(value = ifelse(value == 0, NA, value)) %>%
  pivot_wider(names_from = name, values_from = value) %>%
  column_to_rownames("soil_code")

# Filter tree to the families present in Y
genus_tree_filter <- keep.tip(phy = genus_tree, tip = colnames(Y_genus))
Y_genus <- Y_genus[, genus_tree_filter$tip.label]
Y_genus_trucated <- Y_genus_trucated[, genus_tree_filter$tip.label]

# Sample names from Y
genus_matrix_samples <- rownames(Y_genus)

```


## Covariates

```{r}
covariate_df <- wgs84_coords %>%
  as.data.frame() %>%
  mutate(Sample_code = str_c("ROB_", Sample_code, "_s")) %>%
  filter(Sample_code %in% genus_matrix_samples) %>%
  dplyr::select(-geometry) %>%
  mutate(
    across(where(is.character), ~ as.factor(.x)),
    Cluster = factor(Cluster, levels = unique(Cluster)),
    land_degra = factor(land_degra, levels = c("Low", "Medium", "High"))
  )

covariate_df %>%
  select(Cluster, land_degra, ndvi, precip, tmax,Sample_code) %>% 
  dplyr::filter(Sample_code %in% rownames(Y_genus)) %>%
  dplyr::slice(match(rownames(Y_genus), Sample_code)) %>%
  column_to_rownames("Sample_code") %>%
  mutate(across(where(is.numeric), ~vegan::decostand(.x, method = "standardize")[,1])) -> covariate_standa_df

# write.table(covariate_df, "outputs/covariate_table.txt")

```


```{r}
Y_genus %>%
  as.data.frame() %>%
  rownames_to_column("soil_code") %>%
  pivot_longer(-soil_code, names_to = "genus", values_to = "Abundance") %>%
  group_by(soil_code) %>%
  mutate(RelAbund = Abundance / sum(Abundance)) %>%
  ggplot(aes(x = soil_code, y = RelAbund, fill = genus)) +
  geom_col() +
  labs(y = "Relative abundance") +
  theme(aspect.ratio = 1,
        axis.text.x = element_text(colour = "black", size=7, face="italic",angle = 45, vjust =1, hjust =1),
        axis.text.y = element_text(colour = "black", size=13, face="italic"),
        axis.title = element_text(colour = "black", size=12),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
        legend.title = element_text(colour = "black", size=3,
                                    hjust =0.5),

        legend.text = element_text(colour = "black", size=3))
```

```{r}
library(PLNmodels)
library(corrplot)

setup_data <- prepare_data(Y_genus, covariate_standa_df )


all(rownames(Y_genus) == rownames(covariate_standa_df))


myPLN_full <- PLN(Abundance ~ precip * tmax * ndvi , data =  setup_data,control = PLN_param(covariance = c("full")))
myPLN_sphere <- PLN(Abundance ~ precip * tmax * ndvi , data =  setup_data,control = PLN_param(covariance = c("spherical")))
myPLN_diag <- PLN(Abundance ~ precip * tmax * ndvi , data =  setup_data,control = PLN_param(covariance = c("diagonal")))
myPLN_full_addit <- PLN(Abundance ~ precip + tmax + ndvi , data =  setup_data,control = PLN_param(covariance = c("full")))
myPLN_full_LD <- PLN(Abundance ~ precip * tmax * ndvi +land_degra, data =  setup_data,control = PLN_param(covariance = c("full")))
myPLN_full_C <- PLN(Abundance ~ precip * tmax * ndvi + Cluster, data =  setup_data,control = PLN_param(covariance = c("full")))
myPLN_full_LDC <- PLN(Abundance ~ precip * tmax * ndvi + Cluster +land_degra, data =  setup_data,control = PLN_param(covariance = c("full")))
rbind(
  myPLN_full$criteria,
  myPLN_sphere$criteria,
  myPLN_diag$criteria,
  myPLN_full_addit$criteria,
  myPLN_full_C$criteria,
  myPLN_full_LD$criteria,
  myPLN_full_LDC$criteria
) %>%
  as.data.frame(row.names = c("full", "diagonal", "spherical", "additif","Cluster", "land_degra" ,"land_degra + Cluster")) 
```


```{r}
predicted_data <- matrix(NA, ncol = ncol(Y_genus), nrow = nrow(Y_genus))
colnames(predicted_data) <- colnames(Y_genus)
rownames(predicted_data) <- rownames(Y_genus)

setup_data <- prepare_data(count = Y_genus, covariate = covariate_standa_df)

setup = list(list(frml = formula("Abundance~ precip + tmax + ndvi"), covar = "diagonal"),
             list(frml = formula("Abundance~ precip * tmax * ndvi"), covar = "diagonal"),
             #list(frml = formula("Abundance~ precip * tmax * ndvi + land_degra"), covar = "diagonal"),
             list(frml = formula("Abundance~ precip * tmax * ndvi + Cluster"), covar = "diagonal"),
             #list(frml = formula("Abundance~ precip * tmax * ndvi + land_degra + Cluster"), covar = "diagonal"),
             list(frml = formula("Abundance~ precip + tmax + ndvi"), covar = "spherical"),
             list(frml = formula("Abundance~ precip * tmax * ndvi"), covar = "spherical"),
             #list(frml = formula("Abundance~ precip * tmax * ndvi +land_degra"), covar = "spherical"),
             list(frml = formula("Abundance~ precip * tmax * ndvi + Cluster"), covar = "spherical"),
             #list(frml = formula("Abundance~ precip * tmax * ndvi + land_degra + Cluster"), covar = "spherical"),
             list(frml = formula("Abundance~ precip + tmax + ndvi"), covar = "full"),
             list(frml = formula("Abundance~ precip * tmax*+ ndvi"), covar = "full"),
             #list(frml = formula("Abundance~ precip * tmax * ndvi +land_degra"), covar = "full"),
             list(frml = formula("Abundance~ precip * tmax * ndvi + Cluster"), covar = "full"))
             #list(frml = formula("Abundance~ precip * tmax * ndvi + land_degra + Cluster"), covar = "full"))


recap_df <- data.frame(mod = NA, RMSE =NA) 
vec <- 1:nrow(Y_genus)
ntest <-  4
nfolds <- nrow(Y_genus)/ ntest
set.seed(2001)
rep <- 4
folds <- split(sample(vec,replace = FALSE), ceiling(seq_along(vec) /ntest))
for(set in setup){
  for(r in 1:rep){
    temp <- matrix(0, ncol = ncol(Y_genus), nrow = nrow(Y_genus))
    for(n in 1:nfolds){
        id <- folds[[n]]
        setup_data_temp <- prepare_data(count = Y_genus[-id,], covariate = covariate_standa_df_filter[-id,])
        myPLN <- PLN(set$frml, data =  setup_data_temp, control = PLN_param(covariance = set$covar))
      
        predicted_data[id,] <- predict(myPLN, setup_data[id,],type = "response")
    }
  temp <- temp + predicted_data
  }
  predicted_data_mean <- temp /rep
  RMSE_mod <- data.frame(mod = paste(as.character(set$frml)[3],set$covar[[1]] ,sep =" | "), RMSE = sqrt(sum( (as.vector(Y_genus) -    as.vector(predicted_data_mean))^2)/length(as.vector(predicted_data_mean))))
  recap_df <- rbind(recap_df, RMSE_mod)
}

recap_df %>%
  arrange(RMSE)
```


```{r}
for(r in 1:rep){
  temp <- matrix(0, ncol = ncol(Y_genus), nrow = nrow(Y_genus))
  for(n in 1:nfolds){
      id <- folds[[n]]
      setup_data_temp <- prepare_data(count = Y_genus_filter[-id,], covariate = covariate_standa_df_filter[-id,])
      myPLN <- PLN(Abundance~ precip * tmax * ndvi, data =  setup_data_temp,control = PLN_param(covariance = "spherical"))
    
      predicted_data[id,] <- predict(myPLN, setup_data[id,],type = "response")
  }
  temp <- temp + predicted_data
}
predicted_data <- temp /rep

data.frame(
  fitted   = as.vector(predicted_data),
  observed = as.vector(Y_genus_filter)
) %>% 
  ggplot(aes(x = observed, y = fitted)) + 
    geom_point(size = 4, alpha =.25 ) + 
    geom_smooth(method = "lm", se = F) +
    geom_abline(slope = 1, size = 2) +
    scale_x_log10() +
    scale_y_log10() +
    theme_bw() 

predicted_data %>%
  as.data.frame() %>%
  rownames_to_column("Sample_code") %>%
  pivot_longer(-Sample_code, names_to = "genus",values_to = "predicted") -> predicted_data_long

Y_genus_filter %>%
  as.data.frame() %>%
  rownames_to_column("Sample_code") %>%
  pivot_longer(-Sample_code, names_to = "genus",values_to = "observed") -> observed_data_long

predicted_data_long %>%
  left_join(observed_data_long, by = join_by(genus == genus , Sample_code == Sample_code)) %>%
  ggplot() +
    geom_point(aes(x = observed, y = predicted),size = 2, alpha =.75 ) + 
    #geom_text(aes(x = observed, y = predicted,label = Sample_code),size = 2, alpha =.75 ) + 
    geom_smooth(aes(x = observed, y = predicted),size = 2, alpha =.75 ,method = "lm", se =F) + 
    geom_abline(slope = 1) +
    facet_wrap(~genus,scale = "free" )+
    scale_x_log10() +
    scale_y_log10() +
    theme_bw() 
fitted_data <- predict(myPLN_full_LDC) 
colnames(fitted_data) <- colnames(Y_genus)
rownames(fitted_data) <- rownames(Y_genus)
fitted_data %>%
  as.data.frame() %>%
  rownames_to_column("Sample_code") %>%
  pivot_longer(-Sample_code, names_to = "genus",values_to = "fitted") -> fitted_data_long

fitted_data_long %>%
  left_join(observed_data_long, by = join_by(genus == genus , Sample_code == Sample_code)) %>%
  ggplot() +
    geom_point(aes(x = observed, y = fitted),size = 2, alpha =.75 ) + 
    geom_abline(slope = 1) +
    facet_wrap(~genus,scale = "free" )+
    # scale_x_log10() +
    # scale_y_log10() +
    theme_bw() 
```

```{r}
predicted_data_long %>%
  left_join(observed_data_long, by = join_by(genus == genus , Sample_code == Sample_code)) %>%
  mutate(diff = observed - predicted) %>%
  group_by(genus) %>%
  summarise(n = n(),
            median_abund = median(observed, na.rm = T),
            mean_abund = mean(observed, na.rm = T),
            median_pred = median(predicted, na.rm = T),
            mean_pred = mean(predicted, na.rm = T),
            sd_abund = sd(observed, na.rm = T),
            RMSE = sqrt(sum(diff**2)/n),
            ratio_RMSE_sd = (RMSE)/sd_abund) -> recap_df
recap_df %>%
  ggplot() +
  geom_point(aes(genus, ratio_RMSE_sd))

recap_df %>%
  ggplot() +
  geom_point(aes(mean_abund, RMSE))
recap_df %>%
  ggplot() +
  geom_point(aes(mean_abund, mean_pred))
```


```{r}
land_degradation_raster_df <- rasterToPoints(land_degradation_raster) %>%
  as.data.frame() %>%
  mutate(land_degra = factor(land_degra, labels = levels(land_degradation_raster)[[1]]$land_degra))

cluster_agro_df <- rasterToPoints(cluster_agro_raster) %>%
  as.data.frame() %>%
  mutate(Cluster = factor(Cluster, labels = levels(cluster_agro_raster)[[1]]$Cluster))

ndvi_raster_df <- rasterToPoints(ndvi_uganda) %>%
  as.data.frame() %>%
  rename(ndvi = "ndvi_uganda_lower_res")

precip_raster_df <- rasterToPoints(precip_uganda_resampled) %>%
  as.data.frame() %>%
  rename(precip = "precip_2023_lower_res")

tmax_raster_df <- rasterToPoints(tmax_uganda_resampled) %>%
  as.data.frame() %>%
  rename(tmax = "tmax_2023_lower_res")


data_spatial_df <- tmax_raster_df %>%
  left_join(ndvi_raster_df, by = join_by("x", "y")) %>%
  left_join(precip_raster_df, by = join_by("x", "y")) %>%
  na.omit()
```

```{r}
 myPLN_final <- PLN(Abundance~ precip * tmax * ndvi, data =  setup_data,control = PLN_param(covariance = "diagonal"))
coef(myPLN_final)
myPLN_final$var_par %>% str
myPLN_final$latent_pos
corrplot(
  cov2cor(sigma(myPLN_final)),
  tl.cex = .5
)
```

```{r}
data_spatial_df %>%
  pivot_longer(c(ndvi, tmax, precip)) %>%
  ggplot() +
  facet_wrap(~name) +
  geom_raster(aes(x, y, fill = value))

# Prepare grid for gradient predictions
xy.grid <- data_spatial_df %>%
  dplyr::select(x, y) %>%
  as.matrix()
covariate_pred <- data_spatial_df %>%
  dplyr::select(ndvi, tmax, precip) 

predicted_spatial_data <- predict(myPLN_final, covariate_pred,type = "response")

data_spatial_df %>%
    bind_cols(EpredY) %>%
    pivot_longer(-c(x, y, Cluster, land_degra, ndvi, precip)) %>%
    mutate(value = log10(value + 1)) %>%
    ggplot() +
    facet_wrap(~name) +
    geom_raster(aes(x, y, fill = value)) +
    scale_fill_viridis(option = "cividis", direction = -1) +
    labs(x = "Lon", y = "Lat", fill = "Abundance (log10)") +
    theme_classic() +
    theme(
      aspect.ratio = 1,
      plot.margin = margin(0, 0, 0, 0),
      axis.title.x = element_blank(),
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
      axis.title.y = element_text(colour = "black", size = 14, face = "italic")
    )

data_spatial_df %>%
    bind_cols(EpredY2) %>%
    pivot_longer(-c(x, y, Cluster, land_degra, ndvi, precip)) %>%
    ggplot() +
    facet_wrap(~name) +
    geom_raster(aes(x, y, fill = value)) +
    scale_fill_viridis(option = "magma", direction = -1) +
    labs(x = "Lon", y = "Lat", fill = "Occurrence probability") +
    theme_classic() +
    theme(
      aspect.ratio = 1,
      plot.margin = margin(0, 0, 0, 0),
      axis.title.x = element_blank(),
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
      axis.title.y = element_text(colour = "black", size = 14, face = "italic")
    )

 ug_border <- read_sf("data/ug_shp/ug.shp")

 data_spatial_df %>%
    bind_cols(EpredY2) %>%
    pivot_longer(-c(x, y, Cluster, land_degra, ndvi, precip)) %>%
    group_by(x, y) %>%
    summarise(richness = sum(value, na.rm = TRUE), .groups = "drop") %>%
    ggplot() +
    geom_sf(data = ug_border) +
    geom_raster(aes(x, y, fill = richness)) +
    scale_fill_viridis(option = "viridis", direction = -1) +
    labs(x = "Lon", y = "Lat", fill = "genus richness") +
    theme_classic() +
    theme(
      aspect.ratio = 1,
      plot.margin = margin(0, 0, 0, 0),
      axis.title.x = element_blank(),
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
      axis.title.y = element_text(colour = "black", size = 14, face = "italic")
    )
 
```

# SBM approach

```{r}
library(sbm)

plotMyMatrix(as.matrix(Y_genus_bin))
str(covariate_standa_df2)
m_tmax <- matrix(covariate_standa_df2$tmax, nrow=nrow(Y_genus_bin), ncol=ncol(Y_genus_bin))
m_ndvi <- matrix(covariate_standa_df2$ndvi, nrow=nrow(Y_genus_bin), ncol=ncol(Y_genus_bin))
m_precip <- matrix(covariate_standa_df2$precip, nrow=nrow(Y_genus_bin), ncol=ncol(Y_genus_bin))
myBipartiteSBM <- Y_genus_bin %>%
  as.matrix %>%
  estimateBipartiteSBM('bernoulli',
                        estimOptions = list(plot = T),
                        dimLabels = c(row = "sample", col = "genus"))

plot(myBipartiteSBM, 'expected')

genus_id = myBipartiteSBM$memberships[2]%>%
  as.data.frame()%>%
  rownames_to_column("id")%>%
  mutate(id = as.numeric(id))%>%
  arrange(genus)
grid_id = myBipartiteSBM$memberships[1]%>%
  as.data.frame()%>%
  rownames_to_column("id")%>%
  mutate(id = as.numeric(id))%>%
  arrange(sample)

temp<-as.matrix(predict(myBipartiteSBM)>=0.50) 
temp[temp==T] <- 1
temp[grid_id$id,genus_id$id]%>%
  t()%>%
  plotMyMatrix(dimLabels = c("Genus", "Sample"), plotOptions = list(rowNames = T,colNames = T))+
  geom_hline(yintercept = abs(which(!duplicated(genus_id$genus))[-1]-nrow(genus_id)-1)+0.5, col ="red", linetype = 5)+
  geom_vline(xintercept = which(!duplicated(grid_id$sample))[-1]-0.5, col = "red")+
  
  theme(legend.position = "right",
        element_text(angle = 45, vjust = 1, hjust = 1, size = 0.1, face="italic"),
        strip.text.x = element_text(colour = "gray", size=20, face ="italic"),
        strip.text.y  = element_text(colour = "gray", size=20, face ="italic"),
        axis.text.x =element_text( size = 8, face="italic"),
        axis.text.y = element_text(size = 10,face="italic"),
        strip.background = element_rect(fill="white"),
        panel.border = element_rect(color = "black",  fill = NA))


log1p(predicted_data)[grid_id$id,genus_id$id]%>%
  t()%>%
  plotMyMatrix(dimLabels = c("Genus", "Sample"), plotOptions = list(rowNames = T,colNames = T))+
  geom_hline(yintercept = abs(which(!duplicated(genus_id$genus))[-1]-nrow(genus_id)-1)+0.5, col ="red", linetype = 5)+
  geom_vline(xintercept = which(!duplicated(grid_id$sample))[-1]-0.5, col = "red")+
  
  theme(legend.position = "right",
        element_text(angle = 45, vjust = 1, hjust = 1, size = 0.1, face="italic"),
        strip.text.x = element_text(colour = "gray", size=20, face ="italic"),
        strip.text.y  = element_text(colour = "gray", size=20, face ="italic"),
        axis.text.x =element_text( size = 8, face="italic"),
        axis.text.y = element_text(size = 10,face="italic"),
        strip.background = element_rect(fill="white"),
        panel.border = element_rect(color = "black",  fill = NA))

log1p(predicted_data_hurdel)[grid_id$id,genus_id$id]%>%
  t()%>%
  plotMyMatrix(dimLabels = c("Genus", "Sample"), plotOptions = list(rowNames = T,colNames = T))+
  geom_hline(yintercept = abs(which(!duplicated(genus_id$genus))[-1]-nrow(genus_id)-1)+0.5, col ="red", linetype = 5)+
  geom_vline(xintercept = which(!duplicated(grid_id$sample))[-1]-0.5, col = "red")+
  
  theme(legend.position = "right",
        element_text(angle = 45, vjust = 1, hjust = 1, size = 0.1, face="italic"),
        strip.text.x = element_text(colour = "gray", size=20, face ="italic"),
        strip.text.y  = element_text(colour = "gray", size=20, face ="italic"),
        axis.text.x =element_text( size = 8, face="italic"),
        axis.text.y = element_text(size = 10,face="italic"),
        strip.background = element_rect(fill="white"),
        panel.border = element_rect(color = "black",  fill = NA))
mPredY_bin[grid_id$id,genus_id$id]%>%
  t()%>%
  plotMyMatrix(dimLabels = c("Genus", "Sample"), plotOptions = list(rowNames = T,colNames = T))+
  geom_hline(yintercept = abs(which(!duplicated(genus_id$genus))[-1]-nrow(genus_id)-1)+0.5, col ="red", linetype = 5)+
  geom_vline(xintercept = which(!duplicated(grid_id$sample))[-1]-0.5, col = "red")+
  
  theme(legend.position = "right",
        element_text(angle = 45, vjust = 1, hjust = 1, size = 0.1, face="italic"),
        strip.text.x = element_text(colour = "gray", size=20, face ="italic"),
        strip.text.y  = element_text(colour = "gray", size=20, face ="italic"),
        axis.text.x =element_text( size = 8, face="italic"),
        axis.text.y = element_text(size = 10,face="italic"),
        strip.background = element_rect(fill="white"),
        panel.border = element_rect(color = "black",  fill = NA))
predict(myBipartiteSBM)[grid_id$id,genus_id$id]%>%
  t()%>%
  plotMyMatrix(dimLabels = c("Genus", "Sample"), plotOptions = list(rowNames = T,colNames = T))+
  geom_hline(yintercept = abs(which(!duplicated(genus_id$genus))[-1]-nrow(genus_id)-1)+0.5, col ="red", linetype = 5)+
  geom_vline(xintercept = which(!duplicated(grid_id$sample))[-1]-0.5, col = "red")+
  
  theme(legend.position = "right",
        element_text(angle = 45, vjust = 1, hjust = 1, size = 0.1, face="italic"),
        strip.text.x = element_text(colour = "gray", size=20, face ="italic"),
        strip.text.y  = element_text(colour = "gray", size=20, face ="italic"),
        axis.text.x =element_text( size = 8, face="italic"),
        axis.text.y = element_text(size = 10,face="italic"),
        strip.background = element_rect(fill="white"),
        panel.border = element_rect(color = "black",  fill = NA))
as.matrix(Y_genus_bin)[grid_id$id,genus_id$id]%>%
  t()%>%
  plotMyMatrix(dimLabels = c("Genus", "Sample"), plotOptions = list(rowNames = T,colNames = T))+
  geom_hline(yintercept = abs(which(!duplicated(genus_id$genus))[-1]-nrow(genus_id)-1)+0.5, col ="red", linetype = 5)+
  geom_vline(xintercept = which(!duplicated(grid_id$sample))[-1]-0.5, col = "red")+
  
  theme(legend.position = "right",
        element_text(angle = 45, vjust = 1, hjust = 1, size = 0.1, face="italic"),
        strip.text.x = element_text(colour = "gray", size=20, face ="italic"),
        strip.text.y  = element_text(colour = "gray", size=20, face ="italic"),
        axis.text.x =element_text( size = 8, face="italic"),
        axis.text.y = element_text(size = 10,face="italic"),
        strip.background = element_rect(fill="white"),
        panel.border = element_rect(color = "black",  fill = NA))
```


```{r}
myBipartiteSBM_pois <- Y_genus %>%
  as.matrix %>%
  estimateBipartiteSBM('bernoulli',
                        estimOptions = list(plot = T),
                        dimLabels = c(row = "sample", col = "genus"))
plot(myBipartiteSBM_pois)

genus_id_pois = myBipartiteSBM_pois$memberships[2]%>%
  as.data.frame()%>%
  rownames_to_column("id")%>%
  mutate(id = as.numeric(id))%>%
  arrange(genus)
grid_id_pois = myBipartiteSBM_pois$memberships[1]%>%
  as.data.frame()%>%
  rownames_to_column("id")%>%
  mutate(id = as.numeric(id))%>%
  arrange(sample)

pred_abund_sbm <- round(exp(predict(myBipartiteSBM_pois))-1)

log1p(pred_abund_sbm)[grid_id_pois$id,genus_id_pois$id]%>%
  t()%>%
  plotMyMatrix(dimLabels = c("Genus", "Sample"), plotOptions = list(rowNames = T,colNames = T))+
  geom_hline(yintercept = abs(which(!duplicated(genus_id_pois$genus))[-1]-nrow(genus_id_pois)-1)+0.5, col ="red", linetype = 5)+
  geom_vline(xintercept = which(!duplicated(grid_id_pois$sample))[-1]-0.5, col = "red")+
  
  theme(legend.position = "right",
        element_text(angle = 45, vjust = 1, hjust = 1, size = 0.1, face="italic"),
        strip.text.x = element_text(colour = "gray", size=20, face ="italic"),
        strip.text.y  = element_text(colour = "gray", size=20, face ="italic"),
        axis.text.x =element_text( size = 8, face="italic"),
        axis.text.y = element_text(size = 10,face="italic"),
        strip.background = element_rect(fill="white"),
        panel.border = element_rect(color = "black",  fill = NA))

setup_data_sbm <- prepare_data(count = pred_abund_sbm, covariate = covariate_standa_df2)

predicted_data_pois <- matrix(NA, ncol = ncol(Y_genus), nrow = nrow(Y_genus))
colnames(predicted_data_pois) <- colnames(Y_genus)
rownames(predicted_data_pois) <- rownames(Y_genus)


for(n in 1:nrow(pred_abund_sbm)){
  setup_data_temp <- prepare_data(count = pred_abund_sbm[-n,], covariate = covariate_standa_df2[-n,])
  myPLN <- PLN(Abundance ~ precip * tmax * ndvi, data =  setup_data_temp,control = PLN_param(covariance = c("diagonal")))

  predicted_data_pois[n,] <- predict(myPLN, setup_data[n,],type = "response")
}

data.frame(
  fitted   = as.vector(predicted_data_pois),
  observed = as.vector(Y_genus)
) %>% 
  ggplot(aes(x = observed, y = fitted)) + 
    geom_point(size = 4, alpha =.25 ) + 
    geom_abline(slope = 1, size = 2) +
    scale_x_log10() + 
    scale_y_log10() + 
    theme_bw() + annotation_logticks()

predicted_data_hurdel %>%
  as.data.frame() %>%
  rownames_to_column("Sample_code") %>%
  pivot_longer(-Sample_code, names_to = "genus",values_to = "predicted") -> predicted_data_long

Y_genus %>%
  as.data.frame() %>%
  rownames_to_column("Sample_code") %>%
  pivot_longer(-Sample_code, names_to = "genus",values_to = "observed") -> observed_data_long

predicted_data_long %>%
  left_join(observed_data_long, by = join_by(genus == genus , Sample_code == Sample_code)) %>%
  ggplot() +
    geom_point(aes(x = observed, y = predicted),size = 2, alpha =.75 ) + 
    geom_abline(slope = 1) +
    facet_wrap(~genus )+
    # scale_x_log10() + 
    # scale_y_log10() + 
    theme_bw() 

```


```{r}

```




```{r}
mod_pois$XFormula
Gradient <- constructGradient(mod_pois, focalVariable="tmax")
predY <- stats::predict(m_converg, Gradient = Gradient)

Gradient2 <- prepareGradient(mod_bin, XDataNew = covariate_standa_df)
predY2 <- stats::predict(m_converg_bin, Gradient = Gradient2)

EpredY <- predY[[1]]
EpredY2 <- predY2[[1]]

# Average over predictions
if (length(predY) > 1) {
  for (i in 2:length(predY)) {
    EpredY <- EpredY + predY[[i]]
    if (i %% 1000 == 0) print(i)
  }
  EpredY <- EpredY / length(predY)
}

if (length(predY2) > 1) {
  for (i in 2:length(predY2)) {
    EpredY2 <- EpredY2 + predY2[[i]]
    if (i %% 1000 == 0) print(i)
  }
  EpredY2 <- EpredY2 / length(predY2)
}

rownames(EpredY) <- covariate_standa_df$Sample_code
rownames(EpredY2) <- covariate_standa_df$Sample_code

plotGradient(mod_pois, Gradient, pred=predY, measure="Y",index = 27, showData = TRUE, jigger = 0.2)
```

```{r}
EpredY %>%
  as.data.frame() %>%
  rownames_to_column("soil_code") %>%
  pivot_longer(-soil_code, names_to = "family_names", values_to = "pred_abund") -> EpredY_long
amf_family_rare_testing %>%
  as.data.frame() %>%
  rownames_to_column("soil_code") %>%
  pivot_longer(-soil_code, names_to = "family_names", values_to = "true_abund") -> test_samples_long

EpredY_long %>%
  left_join(test_samples_long, by = join_by(family_names,soil_code)) -> abund_test_df


```

```{r}


abund_test_df %>%
  ggplot()+
  facet_wrap(~family_names, scale = "free") +
  geom_point(aes(true_abund,pred_abund)) +
  labs(x= "Observed abundances", y = "Predicted abudances")

abund_test_df %>%
  mutate(diff = true_abund - pred_abund ) %>%
  group_by(family_names) %>%
  summarise(n = n(),
    RMSE = sqrt(sum(diff**2)/n))
  
```




```{r}
covariate_df$weight = 2
temp <- myBipartiteSBM$memberships$row-1
glmmTMB(cbind(temp, weight-temp) ~ Cluster + land_degra + ndvi + precip,
                     data = covariate_df,
                     family = binomial) -> mod_test
summary(mod_test)
predict(mod_test, type ="response")
```


